<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commercial Lender Database</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Inline Tailwind-like CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.2rem;
            color: #4b5563;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .header {
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #111827;
        }
        
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .mode-text {
            font-size: 0.875rem;
            color: #4b5563;
        }
        
        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .btn-switch {
            background-color: #e5e7eb;
            color: #111827;
        }
        
        .btn-switch:hover {
            background-color: #d1d5db;
        }
        
        .btn-blue {
            background-color: #2563eb;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-blue:hover {
            background-color: #1d4ed8;
        }
        
        .btn-green {
            background-color: #16a34a;
            color: white;
        }
        
        .btn-green:hover {
            background-color: #15803d;
        }
        
        .btn-gray {
            background-color: #4b5563;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-gray:hover:not(:disabled) {
            background-color: #374151;
        }
        
        .btn-gray:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        
        .btn-light {
            background-color: #f3f4f6;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-light:hover {
            background-color: #e5e7eb;
        }
        
        .main-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }
        
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            justify-content: space-between;
        }
        
        .search-container {
            position: relative;
            flex: 1;
            max-width: 28rem;
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            width: 20px;
            height: 20px;
        }
        
        input[type="text"],
        input[type="number"],
        input[type="email"],
        select,
        textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="email"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .search-input {
            padding-left: 2.5rem;
        }
        
        .button-group {
            display: flex;
            gap: 0.75rem;
        }
        
        .filters-panel {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .filter-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .results-count {
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #4b5563;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
        }
        
        td {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
        }
        
        tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        
        tbody tr:hover {
            background-color: #f9fafb;
        }
        
        .lender-name {
            font-weight: 500;
            color: #111827;
        }
        
        .badge {
            display: inline-flex;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .text-gray {
            color: #4b5563;
        }
        
        .text-blue {
            color: #2563eb;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        .text-xs {
            font-size: 0.75rem;
        }
        
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .max-w-xs {
            max-width: 20rem;
        }
        
        .icon-button {
            padding: 0.25rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
            background: transparent;
        }
        
        .icon-button:hover {
            background-color: #f3f4f6;
        }
        
        .icon-button.blue {
            color: #2563eb;
        }
        
        .icon-button.blue:hover {
            background-color: #dbeafe;
        }
        
        .icon-button.red {
            color: #dc2626;
        }
        
        .icon-button.red:hover {
            background-color: #fee2e2;
        }
        
        .icon-button.green {
            color: #16a34a;
        }
        
        .icon-button.green:hover {
            background-color: #dcfce7;
        }
        
        .icon-button.gray {
            color: #4b5563;
        }
        
        .expanded-row {
            background-color: #f9fafb;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            font-size: 0.875rem;
        }
        
        .details-section h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.5rem;
        }
        
        .details-section p {
            margin-bottom: 0.25rem;
            line-height: 1.5;
        }
        
        .detail-label {
            font-weight: 500;
        }
        
        .text-red {
            color: #dc2626;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 0;
            color: #6b7280;
        }
        
        .empty-state-title {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }
        
        .empty-state-subtitle {
            font-size: 0.875rem;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .space-y-1 > * + * {
            margin-top: 0.25rem;
        }
        
        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: -2px;
            font-size: 0.875rem;
        }
        
        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        .tab:hover {
            color: #2563eb;
        }
        
        /* Quote Display */
        .recent-quotes {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .recent-quotes-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        
        .quote-mini {
            display: grid;
            grid-template-columns: auto 1.5fr auto auto auto auto auto auto;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f3f4f6;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            align-items: start;
        }
        
        .quote-mini-label {
            color: #6b7280;
            font-size: 0.7rem;
            font-weight: 500;
            margin-bottom: 0.125rem;
        }
        
        .quote-mini-value {
            color: #111827;
            font-weight: 500;
        }
        
        svg {
            width: 20px;
            height: 20px;
        }
        
        .icon-sm svg {
            width: 18px;
            height: 18px;
        }
        
        .icon-xs svg {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // Data loaded from API

    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Simple icon components
        const SearchIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <circle cx="11" cy="11" r="8" />
                <path d="m21 21-4.35-4.35" />
            </svg>
        );

        const UploadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
        );

        const DownloadIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
        );

        const EditIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
            </svg>
        );

        const SaveIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
            </svg>
        );

        const XIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <line x1="18" y1="6" x2="6" y2="18" />
                <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
        );

        const FilterIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
            </svg>
        );

        const ChevronDownIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <polyline points="6 9 12 15 18 9" />
            </svg>
        );

        const ChevronUpIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <polyline points="18 15 12 9 6 15" />
            </svg>
        );

        const LenderPortal = () => {
          const [lenders, setLenders] = useState([]);
          const [loading, setLoading] = useState(true);
          
          // Load lenders and quotes from API on mount
          useEffect(() => {
            fetchLenders();
            fetchQuotes();
          }, []);
          
          const fetchQuotes = async () => {
            try {
              const response = await fetch('/api/quotes');
              const data = await response.json();
              setQuotes(data);
            } catch (error) {
              console.error('Error fetching quotes:', error);
            }
          };
          
          // Get relevant quotes for a lender (last 12 months, max 3)
          const getRelevantQuotes = (lenderName) => {
            const twelveMonthsAgo = new Date();
            twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);
            
            return quotes
              .filter(q => {
                const quoteLender = (q['Lender '] || q['Lender'] || '').trim();
                if (quoteLender !== lenderName) return false;
                
                try {
                  const quoteDate = new Date(q.Date);
                  if (quoteDate < twelveMonthsAgo) return false;
                } catch (e) {}
                
                return true;
              })
              .sort((a, b) => {
                try {
                  return new Date(b.Date) - new Date(a.Date);
                } catch (e) {
                  return 0;
                }
              })
              .slice(0, 3);
          };

          const fetchLenders = async () => {
            try {
              const response = await fetch('/api/lenders');
              const data = await response.json();
              setLenders(data);
              setLoading(false);
            } catch (error) {
              console.error('Error fetching lenders:', error);
              alert('Error loading lenders. Please refresh the page.');
              setLoading(false);
            }
          };

          // API functions
          const saveLenderToAPI = async (lender) => {
            try {
              if (lender.id) {
                // Update existing
                const response = await fetch(`/api/lenders/${lender.id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(lender)
                });
                return await response.json();
              } else {
                // Create new
                const response = await fetch('/api/lenders', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(lender)
                });
                return await response.json();
              }
            } catch (error) {
              console.error('Error saving lender:', error);
              alert('Error saving lender');
            }
          };

          const deleteLenderFromAPI = async (id) => {
            try {
              await fetch(`/api/lenders/${id}`, { method: 'DELETE' });
            } catch (error) {
              console.error('Error deleting lender:', error);
              alert('Error deleting lender');
            }
          };

          const [isAdmin, setIsAdmin] = useState(false);
          const [editingId, setEditingId] = useState(null);
          const [editForm, setEditForm] = useState({});
          const [searchTerm, setSearchTerm] = useState('');
          const [quotes, setQuotes] = useState([]);
          const [activeTab, setActiveTab] = useState('lenders');
          const [filters, setFilters] = useState({
            lenderType: '',
            minLoan: '',
            maxLoan: '',
            assetType: ''
          });
          const [showFilters, setShowFilters] = useState(false);
          const [expandedRows, setExpandedRows] = useState(new Set());

          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
              header: true,
              skipEmptyLines: true,
              complete: function(results) {
                try {
                  const data = results.data.map((row, index) => ({
                    id: Date.now() + index,
                    ...row
                  }));
                  
                  setLenders(data);
                  alert(`Successfully imported ${data.length} lenders`);
                } catch (error) {
                  alert('Error parsing file. Please ensure it is a valid CSV.');
                  console.error(error);
                }
              },
              error: function(error) {
                alert('Error reading file: ' + error.message);
              }
            });
          };

          const handleExport = () => {
            if (lenders.length === 0) {
              alert('No data to export');
              return;
            }

            const headers = Object.keys(lenders[0]).filter(key => key !== 'id');
            const csv = [
              headers.join(','),
              ...lenders.map(lender => 
                headers.map(header => {
                  const value = lender[header] || '';
                  return value.includes(',') || value.includes('"') ? `"${value.replace(/"/g, '""')}"` : value;
                }).join(',')
              )
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lender_database_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
          };

          const handleExportResults = () => {
            if (filteredLenders.length === 0) {
              alert('No results to export');
              return;
            }

            // Export only the columns we want: Lender, Point of Contact, Email, Phone
            const headers = ['Lender', 'Point of Contact', 'Email', 'Phone'];
            const csv = [
              headers.join(','),
              ...filteredLenders.map(lender => {
                const row = [
                  lender.Lender || '',
                  lender['Point of Contact'] || '',
                  lender.Email || '',
                  lender.Phone || ''
                ];
                return row.map(value => {
                  // Escape values that contain commas or quotes
                  return value.includes(',') || value.includes('"') ? `"${value.replace(/"/g, '""')}"` : value;
                }).join(',');
              })
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lender_results_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
          };

          const startEdit = (lender) => {
            setEditingId(lender.id);
            setEditForm({ ...lender });
          };

          const saveEdit = async () => {
            await saveLenderToAPI(editForm);
            setLenders(lenders.map(l => l.id === editingId ? editForm : l));
            setEditingId(null);
            setEditForm({});
          };

          const cancelEdit = () => {
            setEditingId(null);
            setEditForm({});
          };

          const deleteLender = async (id) => {
            if (confirm('Are you sure you want to delete this lender?')) {
              await deleteLenderFromAPI(id);
              setLenders(lenders.filter(l => l.id !== id));
            }
          };

          const addNewLender = async () => {
            const newLender = {
              Lender: '',
              'Loan Program': '',
              'Lender Type': '',
              'Point of Contact': '',
              Phone: '',
              Email: '',
              Status: '',
              'Min Loan': '',
              'Max Loan': '',
              'Avg. Loan': '',
              Constraints: '',
              'Spread/Pricing': '',
              Structure: '',
              Prepayment: '',
              'Guarantee/Reserves/Covenants': '',
              'Lock/App/Commitment/Closing': '',
              'Fees / Deposits': '',
              'Asset Types/Classes/Markets': '',
              'Will not do': '',
              'Additional Info': ''
            };
            setLenders([newLender, ...lenders]);
            startEdit(newLender);
          };

          const toggleExpand = (id) => {
            const newExpanded = new Set(expandedRows);
            if (newExpanded.has(id)) {
              newExpanded.delete(id);
            } else {
              newExpanded.add(id);
            }
            setExpandedRows(newExpanded);
          };

          // Parse natural language search queries
          const parseSearchQuery = (query) => {
            const parsed = {
              amount: null,
              assetTypes: [],
              lenderTypes: [],
              keywords: []
            };

            if (!query) return parsed;

            const queryLower = query.toLowerCase();

            // Asset type synonyms - map search terms to all related terms
            const assetTypeSynonyms = {
              'multifamily': ['multifamily', 'multi-family', 'apartment', 'apartments', 'residential'],
              'apartment': ['multifamily', 'multi-family', 'apartment', 'apartments', 'residential'],
              'apartments': ['multifamily', 'multi-family', 'apartment', 'apartments', 'residential'],
              'industrial': ['industrial', 'warehouse', 'distribution', 'manufacturing', 'logistics'],
              'warehouse': ['industrial', 'warehouse', 'distribution', 'logistics'],
              'distribution': ['industrial', 'warehouse', 'distribution', 'logistics'],
              'retail': ['retail', 'shopping center', 'strip center', 'mall'],
              'shopping': ['retail', 'shopping center', 'strip center', 'mall'],
              'mall': ['retail', 'shopping center', 'strip center', 'mall'],
              'office': ['office', 'medical office'],
              'hotel': ['hotel', 'hospitality', 'lodging'],
              'hospitality': ['hotel', 'hospitality', 'lodging'],
              'self storage': ['self storage', 'self-storage', 'storage'],
              'storage': ['self storage', 'self-storage', 'storage'],
              'mixed use': ['mixed use', 'mixed-use'],
              'student housing': ['student housing', 'student'],
              'senior housing': ['senior housing', 'senior', 'assisted living'],
            };

            // Extract loan amount (e.g., "$5 million", "5m", "5000000", "5MM")
            const amountPatterns = [
              /\$?\s*(\d+(?:\.\d+)?)\s*(?:million|m|mm)/i,
              /\$?\s*(\d{7,})/,  // 7+ digits assumed to be full amount
            ];

            for (const pattern of amountPatterns) {
              const match = queryLower.match(pattern);
              if (match) {
                let amount = parseFloat(match[1]);
                // Convert millions to actual number
                if (queryLower.includes('million') || queryLower.includes('mm') || (queryLower.includes('m') && !queryLower.includes('million'))) {
                  amount = amount * 1000000;
                }
                parsed.amount = amount;
                break;
              }
            }

            // Extract asset types and expand with synonyms
            const assetTypeKeywords = [
              'industrial', 'multifamily', 'multi-family', 'apartment', 'apartments', 'retail', 'office', 
              'warehouse', 'distribution', 'flex', 'self storage', 'self-storage', 'storage',
              'medical', 'hospitality', 'hotel', 'mixed use', 'mixed-use',
              'student housing', 'senior housing', 'manufactured housing',
              'shopping center', 'mall', 'strip center', 'land', 'development'
            ];

            const foundAssetTypes = new Set();
            for (const assetType of assetTypeKeywords) {
              if (queryLower.includes(assetType)) {
                // Add the found term and all its synonyms
                if (assetTypeSynonyms[assetType]) {
                  assetTypeSynonyms[assetType].forEach(syn => foundAssetTypes.add(syn));
                } else {
                  foundAssetTypes.add(assetType);
                }
              }
            }
            parsed.assetTypes = Array.from(foundAssetTypes);

            // Extract lender types
            const lenderTypeKeywords = [
              'bank', 'lifeco', 'life company', 'cmbs', 'debt fund', 'agency', 
              'freddie', 'fannie', 'credit union', 'insurance'
            ];

            for (const lenderType of lenderTypeKeywords) {
              if (queryLower.includes(lenderType)) {
                parsed.lenderTypes.push(lenderType);
              }
            }

            // Extract remaining keywords (words not part of amount or common words)
            const commonWords = ['the', 'a', 'an', 'in', 'for', 'with', 'loan', 'lender', 'lenders', 'million', 'm', 'mm'];
            const words = query.toLowerCase().split(/\s+/).filter(word => 
              word.length > 2 && 
              !commonWords.includes(word) &&
              !word.match(/^\$?\d/) && // Not a number
              !word.match(/^[\$,.]/) // Not starting with $, comma, or period
            );
            parsed.keywords = words;

            return parsed;
          };

          const filteredLenders = useMemo(() => {
            return lenders.filter(lender => {
              // Parse search term for intelligent filtering
              if (searchTerm) {
                const parsed = parseSearchQuery(searchTerm);
                
                // Check loan amount if specified
                if (parsed.amount) {
                  const minLoan = parseFloat(lender['Min Loan']?.replace(/[^0-9.]/g, '') || 0);
                  const maxLoan = parseFloat(lender['Max Loan']?.replace(/[^0-9.]/g, '') || Infinity);
                  
                  // Amount must be within lender's range
                  if (parsed.amount < minLoan || parsed.amount > maxLoan) {
                    return false;
                  }
                }

                // Check asset types if specified
                if (parsed.assetTypes.length > 0) {
                  const lenderAssetTypes = (lender['Asset Types/Classes/Markets'] || '').toLowerCase();
                  const lenderWillNotDo = (lender['Will not do'] || '').toLowerCase();
                  
                  // ONLY exclude if lender explicitly says they won't do this asset type
                  const hasExclusion = parsed.assetTypes.some(assetType => 
                    lenderWillNotDo.includes(assetType)
                  );
                  
                  if (hasExclusion) {
                    return false;
                  }

                  // If lender has asset type info, check if it matches
                  // If no asset type info, include them (benefit of the doubt)
                  if (lenderAssetTypes.trim()) {
                    const hasAssetType = parsed.assetTypes.some(assetType => 
                      lenderAssetTypes.includes(assetType) || 
                      lenderAssetTypes.includes('all') ||
                      lenderAssetTypes.includes('any')
                    );
                    
                    // Only exclude if they have asset info but it doesn't match
                    if (!hasAssetType) {
                      return false;
                    }
                  }
                  // If lenderAssetTypes is empty/blank, we include them by default
                }

                // Check lender types if specified
                if (parsed.lenderTypes.length > 0) {
                  const lenderType = (lender['Lender Type'] || '').toLowerCase();
                  const hasType = parsed.lenderTypes.some(type => 
                    lenderType.includes(type)
                  );
                  
                  if (!hasType) {
                    return false;
                  }
                }

                // Check remaining keywords against all searchable fields
                if (parsed.keywords.length > 0 && parsed.assetTypes.length === 0) {
                  const searchableFields = [
                    lender.Lender,
                    lender['Lender Type'],
                    lender['Asset Types/Classes/Markets'],
                    lender['Point of Contact'],
                    lender['Additional Info']
                  ].join(' ').toLowerCase();
                  
                  const hasKeyword = parsed.keywords.some(keyword => 
                    searchableFields.includes(keyword)
                  );
                  
                  if (!hasKeyword) {
                    return false;
                  }
                }
              }

              // Apply filter panel criteria
              if (filters.lenderType && lender['Lender Type'] !== filters.lenderType) {
                return false;
              }

              if (filters.minLoan) {
                const minLoan = parseFloat(lender['Min Loan']?.replace(/[^0-9.]/g, '') || 0);
                if (minLoan > parseFloat(filters.minLoan)) return false;
              }

              if (filters.maxLoan) {
                const maxLoan = parseFloat(lender['Max Loan']?.replace(/[^0-9.]/g, '') || Infinity);
                if (maxLoan < parseFloat(filters.maxLoan)) return false;
              }

              if (filters.assetType) {
                const assetTypes = (lender['Asset Types/Classes/Markets'] || '').toLowerCase();
                if (!assetTypes.includes(filters.assetType.toLowerCase())) return false;
              }

              return true;
            });
          }, [lenders, searchTerm, filters]);

          const lenderTypes = useMemo(() => {
            return [...new Set(lenders.map(l => l['Lender Type']).filter(Boolean))].sort();
          }, [lenders]);

          if (loading) {
            return <div className="loading">Loading lenders...</div>;
          }

          return (
            <div>
              <div className="header">
                <div className="header-content">
                  <h1>Commercial Lender Database</h1>
                  <div className="mode-toggle">
                    <span className="mode-text">
                      {isAdmin ? 'üë§ Admin Mode' : 'üë• Broker Mode'}
                    </span>
                    <button onClick={() => setIsAdmin(!isAdmin)} className="btn-switch">
                      Switch Mode
                    </button>
                  </div>
                </div>
              </div>

              <div className="main-content">
                {/* Tab Navigation */}
                <div className="tabs">
                  <button 
                    className={`tab ${activeTab === 'lenders' ? 'active' : ''}`}
                    onClick={() => setActiveTab('lenders')}
                  >
                    üîç Lender Search ({filteredLenders.length})
                  </button>
                  <button 
                    className={`tab ${activeTab === 'quotes' ? 'active' : ''}`}
                    onClick={() => setActiveTab('quotes')}
                  >
                    üìä Quote Database ({quotes.length})
                  </button>
                </div>

                {activeTab === 'lenders' && (
                <div className="card">
                  <div className="action-bar">
                    <div style={{display: 'flex', gap: '0.75rem', flex: 1}}>
                      <div className="search-container">
                        <div className="search-icon"><SearchIcon /></div>
                        <input
                          type="text"
                          className="search-input"
                          placeholder="Try: '$5 million industrial' or 'multifamily bank' or 'retail 10m'"
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                        />
                      </div>

                      <button onClick={() => setShowFilters(!showFilters)} className="btn-light">
                        <FilterIcon />
                        Filters
                        <span className="icon-xs">{showFilters ? <ChevronUpIcon /> : <ChevronDownIcon />}</span>
                      </button>
                    </div>

                    <div className="button-group">
                      {isAdmin && (
                        <>
                          <label className="btn-blue" style={{cursor: 'pointer'}}>
                            <UploadIcon />
                            Import CSV
                            <input type="file" accept=".csv" onChange={handleFileUpload} />
                          </label>

                          <button onClick={addNewLender} className="btn-green">
                            + Add Lender
                          </button>
                        </>
                      )}

                      <button
                        onClick={handleExportResults}
                        disabled={filteredLenders.length === 0}
                        className="btn-blue"
                        title="Export filtered results (Lender, Contact, Email, Phone)"
                      >
                        <DownloadIcon />
                        Export Results
                      </button>

                      <button onClick={handleExport} disabled={lenders.length === 0} className="btn-gray">
                        <DownloadIcon />
                        Export All
                      </button>
                    </div>
                  </div>

                  {showFilters && (
                    <div className="filters-panel">
                      <div className="filter-group">
                        <label>Lender Type</label>
                        <select
                          value={filters.lenderType}
                          onChange={(e) => setFilters({ ...filters, lenderType: e.target.value })}
                        >
                          <option value="">All Types</option>
                          {lenderTypes.map(type => (
                            <option key={type} value={type}>{type}</option>
                          ))}
                        </select>
                      </div>

                      <div className="filter-group">
                        <label>Min Loan Amount</label>
                        <input
                          type="number"
                          placeholder="e.g., 1000000"
                          value={filters.minLoan}
                          onChange={(e) => setFilters({ ...filters, minLoan: e.target.value })}
                        />
                      </div>

                      <div className="filter-group">
                        <label>Max Loan Amount</label>
                        <input
                          type="number"
                          placeholder="e.g., 50000000"
                          value={filters.maxLoan}
                          onChange={(e) => setFilters({ ...filters, maxLoan: e.target.value })}
                        />
                      </div>

                      <div className="filter-group">
                        <label>Asset Type</label>
                        <input
                          type="text"
                          placeholder="e.g., industrial, multifamily"
                          value={filters.assetType}
                          onChange={(e) => setFilters({ ...filters, assetType: e.target.value })}
                        />
                      </div>

                      <button
                        onClick={() => setFilters({ lenderType: '', minLoan: '', maxLoan: '', assetType: '' })}
                        className="btn-light"
                      >
                        Clear Filters
                      </button>
                    </div>
                  )}
                </div>

                <div className="results-count">
                  Showing {filteredLenders.length} of {lenders.length} lenders
                </div>

                <div className="card">
                  {filteredLenders.length === 0 ? (
                    <div className="empty-state">
                      {lenders.length === 0 ? (
                        <div>
                          <p className="empty-state-title">No lenders in database</p>
                          <p className="empty-state-subtitle">Upload a CSV file to get started</p>
                        </div>
                      ) : (
                        <p>No lenders match your search criteria</p>
                      )}
                    </div>
                  ) : (
                    <div className="table-container">
                      <table>
                        <thead>
                          <tr>
                            <th>Lender</th>
                            <th>Type</th>
                            <th>Loan Range</th>
                            <th>Asset Types</th>
                            <th>Contact</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {filteredLenders.map((lender) => (
                            <React.Fragment key={lender.id}>
                              <tr>
                                <td>
                                  {editingId === lender.id ? (
                                    <input
                                      type="text"
                                      value={editForm.Lender || ''}
                                      onChange={(e) => setEditForm({ ...editForm, Lender: e.target.value })}
                                    />
                                  ) : (
                                    <div className="lender-name">{lender.Lender}</div>
                                  )}
                                </td>
                                <td>
                                  {editingId === lender.id ? (
                                    <input
                                      type="text"
                                      value={editForm['Lender Type'] || ''}
                                      onChange={(e) => setEditForm({ ...editForm, 'Lender Type': e.target.value })}
                                    />
                                  ) : (
                                    <span className="badge">{lender['Lender Type']}</span>
                                  )}
                                </td>
                                <td className="text-gray">
                                  {editingId === lender.id ? (
                                    <div className="space-y-1">
                                      <input
                                        type="text"
                                        placeholder="Min"
                                        value={editForm['Min Loan'] || ''}
                                        onChange={(e) => setEditForm({ ...editForm, 'Min Loan': e.target.value })}
                                        style={{fontSize: '0.75rem'}}
                                      />
                                      <input
                                        type="text"
                                        placeholder="Max"
                                        value={editForm['Max Loan'] || ''}
                                        onChange={(e) => setEditForm({ ...editForm, 'Max Loan': e.target.value })}
                                        style={{fontSize: '0.75rem'}}
                                      />
                                    </div>
                                  ) : (
                                    <div>
                                      {lender['Min Loan'] && <div>Min: {lender['Min Loan']}</div>}
                                      {lender['Max Loan'] && <div>Max: {lender['Max Loan']}</div>}
                                    </div>
                                  )}
                                </td>
                                <td className="text-gray max-w-xs">
                                  {editingId === lender.id ? (
                                    <textarea
                                      value={editForm['Asset Types/Classes/Markets'] || ''}
                                      onChange={(e) => setEditForm({ ...editForm, 'Asset Types/Classes/Markets': e.target.value })}
                                      rows="2"
                                      style={{fontSize: '0.75rem'}}
                                    />
                                  ) : (
                                    <div className="truncate">{lender['Asset Types/Classes/Markets']}</div>
                                  )}
                                </td>
                                <td className="text-gray">
                                  {editingId === lender.id ? (
                                    <div className="space-y-1">
                                      <input
                                        type="text"
                                        placeholder="Name"
                                        value={editForm['Point of Contact'] || ''}
                                        onChange={(e) => setEditForm({ ...editForm, 'Point of Contact': e.target.value })}
                                        style={{fontSize: '0.75rem'}}
                                      />
                                      <input
                                        type="text"
                                        placeholder="Phone"
                                        value={editForm.Phone || ''}
                                        onChange={(e) => setEditForm({ ...editForm, Phone: e.target.value })}
                                        style={{fontSize: '0.75rem'}}
                                      />
                                      <input
                                        type="email"
                                        placeholder="Email"
                                        value={editForm.Email || ''}
                                        onChange={(e) => setEditForm({ ...editForm, Email: e.target.value })}
                                        style={{fontSize: '0.75rem'}}
                                      />
                                    </div>
                                  ) : (
                                    <div>
                                      {lender['Point of Contact'] && <div>{lender['Point of Contact']}</div>}
                                      {lender.Phone && <div className="text-xs">{lender.Phone}</div>}
                                      {lender.Email && <div className="text-xs text-blue">{lender.Email}</div>}
                                    </div>
                                  )}
                                </td>
                                <td>
                                  {editingId === lender.id ? (
                                    <div style={{display: 'flex', gap: '0.5rem'}}>
                                      <button onClick={saveEdit} className="icon-button green" title="Save">
                                        <span className="icon-sm"><SaveIcon /></span>
                                      </button>
                                      <button onClick={cancelEdit} className="icon-button red" title="Cancel">
                                        <span className="icon-sm"><XIcon /></span>
                                      </button>
                                    </div>
                                  ) : (
                                    <div style={{display: 'flex', gap: '0.5rem'}}>
                                      <button onClick={() => toggleExpand(lender.id)} className="icon-button gray" title="View Details">
                                        <span className="icon-sm">{expandedRows.has(lender.id) ? <ChevronUpIcon /> : <ChevronDownIcon />}</span>
                                      </button>
                                      {isAdmin && (
                                        <>
                                          <button onClick={() => startEdit(lender)} className="icon-button blue" title="Edit">
                                            <span className="icon-sm"><EditIcon /></span>
                                          </button>
                                          <button onClick={() => deleteLender(lender.id)} className="icon-button red" title="Delete">
                                            <span className="icon-sm"><XIcon /></span>
                                          </button>
                                        </>
                                      )}
                                    </div>
                                  )}
                                </td>
                              </tr>
                              
                              {expandedRows.has(lender.id) && (
                                <tr className="expanded-row">
                                  <td colSpan="6" style={{padding: '1rem'}}>
                                    <div className="details-grid">
                                      <div className="details-section">
                                        <h4>Loan Details</h4>
                                        {editingId === lender.id ? (
                                          <>
                                            <p><span className="detail-label">Program:</span><br/>
                                              <input type="text" value={editForm['Loan Program'] || ''} 
                                                onChange={(e) => setEditForm({ ...editForm, 'Loan Program': e.target.value })} />
                                            </p>
                                            <p><span className="detail-label">Avg Loan:</span><br/>
                                              <input type="text" value={editForm['Avg. Loan'] || ''} 
                                                onChange={(e) => setEditForm({ ...editForm, 'Avg. Loan': e.target.value })} />
                                            </p>
                                            <p><span className="detail-label">Constraints:</span><br/>
                                              <textarea value={editForm.Constraints || ''} 
                                                onChange={(e) => setEditForm({ ...editForm, Constraints: e.target.value })} />
                                            </p>
                                            <p><span className="detail-label">Pricing:</span><br/>
                                              <textarea value={editForm['Spread/Pricing'] || ''} 
                                                onChange={(e) => setEditForm({ ...editForm, 'Spread/Pricing': e.target.value })} />
                                            </p>
                                          </>
                                        ) : (
                                          <>
                                            {lender['Loan Program'] && <p><span className="detail-label">Program:</span> {lender['Loan Program']}</p>}
                                            {lender['Avg. Loan'] && <p><span className="detail-label">Avg Loan:</span> {lender['Avg. Loan']}</p>}
                                            {lender.Constraints && <p><span className="detail-label">Constraints:</span> {lender.Constraints}</p>}
                                            {lender['Spread/Pricing'] && <p><span className="detail-label">Pricing:</span> {lender['Spread/Pricing']}</p>}
                                          </>
                                        )}
                                      </div>
                                      <div className="details-section">
                                        <h4>Structure & Terms</h4>
                                        {editingId === lender.id ? (
                                          <>
                                            <p><span className="detail-label">Structure:</span><br/>
                                              <textarea value={editForm.Structure || ''} 
                                                onChange={(e) => setEditForm({ ...editForm, Structure: e.target.value })} />
                                            </p>
                                            <p><span className="detail-label">Prepayment:</span><br/>
                                              <textarea value={editForm.Prepayment || ''} 
                                                onChange={(e) => setEditForm({ ...editForm, Prepayment: e.target.value })} />
                                            </p>
                                            <p><span className="detail-label">Guarantees:</span><br/>
                                              <textarea value={editForm['Guarantee/Reserves/Covenants'] || ''} 
                                                onChange={(e) => setEditForm({ ...editForm, 'Guarantee/Reserves/Covenants': e.target.value })} />
                                            </p>
                                            <p><span className="detail-label">Fees:</span><br/>
                                              <textarea value={editForm['Fees / Deposits'] || ''} 
                                                onChange={(e) => setEditForm({ ...editForm, 'Fees / Deposits': e.target.value })} />
                                            </p>
                                            <p><span className="detail-label">Lock/App/Commitment:</span><br/>
                                              <textarea value={editForm['Lock/App/Commitment/Closing'] || ''} 
                                                onChange={(e) => setEditForm({ ...editForm, 'Lock/App/Commitment/Closing': e.target.value })} />
                                            </p>
                                          </>
                                        ) : (
                                          <>
                                            {lender.Structure && <p><span className="detail-label">Structure:</span> {lender.Structure}</p>}
                                            {lender.Prepayment && <p><span className="detail-label">Prepayment:</span> {lender.Prepayment}</p>}
                                            {lender['Guarantee/Reserves/Covenants'] && <p><span className="detail-label">Guarantees:</span> {lender['Guarantee/Reserves/Covenants']}</p>}
                                            {lender['Fees / Deposits'] && <p><span className="detail-label">Fees:</span> {lender['Fees / Deposits']}</p>}
                                          </>
                                        )}
                                      </div>
                                      {(lender['Will not do'] || lender['Additional Info'] || editingId === lender.id) && (
                                        <div className="details-section" style={{gridColumn: '1 / -1'}}>
                                          <h4>Additional Information</h4>
                                          {editingId === lender.id ? (
                                            <>
                                              <p><span className="detail-label text-red">Will Not Do:</span><br/>
                                                <textarea value={editForm['Will not do'] || ''} 
                                                  onChange={(e) => setEditForm({ ...editForm, 'Will not do': e.target.value })} />
                                              </p>
                                              <p><span className="detail-label">Notes:</span><br/>
                                                <textarea value={editForm['Additional Info'] || ''} 
                                                  onChange={(e) => setEditForm({ ...editForm, 'Additional Info': e.target.value })} />
                                              </p>
                                            </>
                                          ) : (
                                            <>
                                              {lender['Will not do'] && <p><span className="detail-label text-red">Will Not Do:</span> {lender['Will not do']}</p>}
                                              {lender['Additional Info'] && <p><span className="detail-label">Notes:</span> {lender['Additional Info']}</p>}
                                            </>
                                          )}
                                        </div>
                                      )}
                                    </div>
                                    
                                    {/* Recent Quotes */}
                                    {(() => {
                                      const relevantQuotes = getRelevantQuotes(lender.Lender);
                                      if (relevantQuotes.length === 0) return null;
                                      
                                      return (
                                        <div className="recent-quotes">
                                          <div className="recent-quotes-header">
                                            üìä Recent Quotes (Last 12 Months)
                                          </div>
                                          {relevantQuotes.map((quote, qIdx) => (
                                            <div key={qIdx} className="quote-mini">
                                              <div>
                                                <div className="quote-mini-label">Date</div>
                                                <div className="quote-mini-value">{quote.Date}</div>
                                              </div>
                                              <div>
                                                <div className="quote-mini-label">Deal</div>
                                                <div className="quote-mini-value" style={{fontSize: '0.75rem'}}>
                                                  {(quote['Deal Name'] || '').substring(0, 35)}
                                                  {(quote['Deal Name'] || '').length > 35 ? '...' : ''}
                                                </div>
                                              </div>
                                              <div>
                                                <div className="quote-mini-label">Amount</div>
                                                <div className="quote-mini-value">{quote.Proceeds}</div>
                                              </div>
                                              <div>
                                                <div className="quote-mini-label">LTV</div>
                                                <div className="quote-mini-value">{quote.Leverage}</div>
                                              </div>
                                              <div>
                                                <div className="quote-mini-label">Spread</div>
                                                <div className="quote-mini-value">{quote.Spread || 'n/a'}</div>
                                              </div>
                                              <div>
                                                <div className="quote-mini-label">Rate</div>
                                                <div className="quote-mini-value">{quote['Full Rate']}</div>
                                              </div>
                                              <div>
                                                <div className="quote-mini-label">Term</div>
                                                <div className="quote-mini-value">{quote.Term}</div>
                                              </div>
                                              <div>
                                                <div className="quote-mini-label">Amort</div>
                                                <div className="quote-mini-value">{quote.Amoritization}</div>
                                              </div>
                                            </div>
                                          ))}
                                        </div>
                                      );
                                    })()}
                                  </td>
                                </tr>
                              )}
                            </React.Fragment>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
                )}
                
                {/* Quote Database Tab */}
                {activeTab === 'quotes' && (
                  <div className="card">
                    <h2 style={{marginBottom: '1rem', fontSize: '1.25rem', fontWeight: '600'}}>Quote Database</h2>
                    <p style={{color: '#6b7280', marginBottom: '1rem'}}>
                      Showing all {quotes.length} historical quotes
                    </p>
                    {quotes.length === 0 ? (
                      <div style={{textAlign: 'center', padding: '3rem', color: '#6b7280'}}>
                        <p>No quotes loaded. Make sure quotes.json is uploaded to your server.</p>
                      </div>
                    ) : (
                      <div className="table-container">
                        <table>
                          <thead>
                            <tr>
                              <th>Date</th>
                              <th>Deal Name</th>
                              <th>Lender</th>
                              <th>Property Type</th>
                              <th>Proceeds</th>
                              <th>LTV</th>
                              <th>Spread</th>
                              <th>Rate</th>
                              <th>Term</th>
                              <th>Amort</th>
                            </tr>
                          </thead>
                          <tbody>
                            {quotes.slice(0, 50).map((quote, idx) => (
                              <tr key={idx}>
                                <td>{quote.Date}</td>
                                <td>{quote['Deal Name']}</td>
                                <td>{(quote['Lender '] || quote['Lender'] || '').trim()}</td>
                                <td>{quote['Product Type']}</td>
                                <td>{quote.Proceeds}</td>
                                <td>{quote.Leverage}</td>
                                <td>{quote.Spread || 'n/a'}</td>
                                <td>{quote['Full Rate']}</td>
                                <td>{quote.Term}</td>
                                <td>{quote.Amoritization}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                        {quotes.length > 50 && (
                          <p style={{marginTop: '1rem', color: '#6b7280', fontSize: '0.875rem'}}>
                            Showing first 50 of {quotes.length} quotes
                          </p>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<LenderPortal />, document.getElementById('root'));
    </script>
</body>
</html>
